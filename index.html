<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Finances Personnelles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .income-color {
            color: #4ade80;
            background-color: rgba(74, 222, 128, 0.1);
        }
        .expense-color {
            color: #f87171;
            background-color: rgba(248, 113, 113, 0.1);
        }
        .peaceful-green {
            background-color: #d1fae5;
        }
        .powder-pink {
            background-color: #fce7f3;
        }
        .soft-yellow {
            background-color: #fef3c7;
        }
        .light-blue {
            background-color: #e0f2fe;
        }
        .crisp-white {
            background-color: #ffffff;
        }
    </style>
</head>
<body class="peaceful-green min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Mon Suivi Financier</h1>
                <p class="text-gray-600">Tableau de bord complet</p>
            </div>
            <div class="flex space-x-4">
                <button id="createMonthBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">
                    Créer un nouveau mois
                </button>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Summary Cards -->
                <div class="crisp-white rounded-lg shadow p-6">
                    <h3 class="font-medium text-gray-500 mb-2">Total Épargne</h3>
                    <p class="text-3xl font-semibold text-green-500" id="totalSavings">0 €</p>
                </div>
                <div class="crisp-white rounded-lg shadow p-6">
                    <h3 class="font-medium text-gray-500 mb-2">Épargne Plaisir</h3>
                    <p class="text-3xl font-semibold text-blue-500" id="totalFunSavings">0 €</p>
                </div>
                <div class="crisp-white rounded-lg shadow p-6">
                    <h3 class="font-medium text-gray-500 mb-2">Dépenses Nécessaires</h3>
                    <p class="text-3xl font-semibold text-red-500" id="totalExpenses">0 €</p>
                </div>
                <div class="crisp-white rounded-lg shadow p-6">
                    <h3 class="font-medium text-gray-500 mb-2">Budget Plaisir</h3>
                    <p class="text-3xl font-semibold text-purple-500" id="totalFunBudget">0 €</p>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="crisp-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Répartition des Finances</h2>
                <div class="w-full md:w-1/2 mx-auto">
                    <canvas id="financePieChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Monthly Sections -->
        <section id="monthSections" class="space-y-8">
            <!-- Sample Month (Will be dynamically generated) -->
        </section>

        <!-- Modal for Adding Transactions -->
        <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="crisp-white rounded-lg shadow-lg p-6 w-full max-w-md">
                <h2 id="modalTitle" class="text-xl font-semibold mb-4">Ajouter une Transaction</h2>
                <form id="transactionForm">
                    <input type="hidden" id="transactionType" value="">
                    <input type="hidden" id="monthId" value="">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="transactionDate">Date</label>
                        <input type="date" id="transactionDate" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="transactionAmount">Montant</label>
                        <input type="number" step="0.01" id="transactionAmount" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="transactionCategory">Catégorie/Type</label>
                        <select id="transactionCategory" class="w-full px-3 py-2 border rounded-md" required>
                            <!-- Options will be filled dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="transactionDescription">Description</label>
                        <textarea id="transactionDescription" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancelTransaction" class="px-4 py-2 border rounded-md">Annuler</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Ajouter</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for Creating New Month -->
        <div id="newMonthModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="crisp-white rounded-lg shadow-lg p-6 w-full max-w-md">
                <h2 class="text-xl font-semibold mb-4">Créer un Nouveau Mois</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Nom du Mois</label>
                    <input type="text" id="newMonthName" class="w-full px-3 py-2 border rounded-md" value="" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Solde de Base</label>
                    <input type="number" step="0.01" id="startingBalance" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre solde initial">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelNewMonth" class="px-4 py-2 border rounded-md">Annuler</button>
                    <button type="button" id="confirmNewMonth" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Créer</button>
                </div>
            </div>
        </div>
    </div>
<!-- Firebase SDKs -->


<script>
const firebaseConfig = {
  apiKey: "AIzaSyAgCJMbySrCoBukCZTyQz2TQM02zrbR2lg",
  authDomain: "suiviedefinancemathias.firebaseapp.com",
  projectId: "suiviedefinancemathias",
  storageBucket: "suiviedefinancemathias.firebasestorage.app",
  messagingSenderId: "965586524937",
  appId: "1:965586524937:web:897552acc848a7827011d8"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
    <script>
        // App State
        const state = {
            months: JSON.parse(localStorage.getItem('financeMonths')) || {},
            currentMonth: null
        };

        // Category Options
        const categories = {
            income: ['Travail', 'Cadeau', 'Revente', 'Solde de base'],
            expenses: ['Loyer', 'Internet', 'Electricité', 'Téléphone', 'Transport', 'Courses', 'Assurance', 'Netflix', 'Spotify', 'Autres'],
            saving: ['Épargne', 'Épargne plaisir', 'Loisirs']
        };

        // DOM Elements
        const elements = {
            monthSections: document.getElementById('monthSections'),
            createMonthBtn: document.getElementById('createMonthBtn'),
            transactionModal: document.getElementById('transactionModal'),
            newMonthModal: document.getElementById('newMonthModal'),
            financePieChart: document.getElementById('financePieChart'),
            totalSavings: document.getElementById('totalSavings'),
            totalFunSavings: document.getElementById('totalFunSavings'),
            totalExpenses: document.getElementById('totalExpenses'),
            totalFunBudget: document.getElementById('totalFunBudget')
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
        db.ref('months').on('value', snapshot => {
    state.months = snapshot.val() || {};
    renderDashboard();
    renderAllMonths();
});

    initializeEventListeners();
});

        // Event Listeners
        function initializeEventListeners() {
            // Create new month
            elements.createMonthBtn.addEventListener('click', showNewMonthModal);
            document.getElementById('cancelNewMonth').addEventListener('click', () => {
                elements.newMonthModal.classList.add('hidden');
            });
            document.getElementById('confirmNewMonth').addEventListener('click', createNewMonth);

            // Transaction modal
            document.getElementById('cancelTransaction').addEventListener('click', () => {
                elements.transactionModal.classList.add('hidden');
            });
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
        }

        // Show new month modal
        function showNewMonthModal() {
            const now = new Date();
            const monthName = now.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            document.getElementById('newMonthName').value = monthName;
            elements.newMonthModal.classList.remove('hidden');
        }

        // Create new month
        function createNewMonth() {
            const monthName = document.getElementById('newMonthName').value;
            const startingBalance = parseFloat(document.getElementById('startingBalance').value) || 0;

            if (state.months[monthName]) {
                alert(`Le mois ${monthName} existe déjà.`);
                return;
            }

            state.months[monthName] = {
                income: [],
                expenses: [],
                saving: [],
                startingBalance: startingBalance
            };

            saveState();
            db.ref('months/' + monthName).set(state.months[monthName]);;
            renderMonth(monthName, state.months[monthName]);
            elements.newMonthModal.classList.add('hidden');
            renderDashboard();
        }

        // Show transaction form
        function showTransactionForm(monthId, type) {
            state.currentMonth = monthId;
            document.getElementById('transactionType').value = type;
            document.getElementById('monthId').value = monthId;
            document.getElementById('modalTitle').textContent = `Ajouter ${getTransactionTypeLabel(type)}`;

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;

            // Clear previous values
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionDescription').value = '';

            // Setup category dropdown
            const categorySelect = document.getElementById('transactionCategory');
            categorySelect.innerHTML = '';
            const options = categories[type].map(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                return option;
            });
            options.forEach(opt => categorySelect.appendChild(opt));

            elements.transactionModal.classList.remove('hidden');
        }

        function getTransactionTypeLabel(type) {
            switch(type) {
                case 'income': return 'une Entrée';
                case 'expenses': return 'une Dépense Nécessaire';
                case 'saving': return 'un Plaisir/Épargne';
                default: return 'une Transaction';
            }
        }

        // Add transaction
        function addTransaction(e) {
            e.preventDefault();

            const monthId = document.getElementById('monthId').value;
            const type = document.getElementById('transactionType').value;
            const date = document.getElementById('transactionDate').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const category = document.getElementById('transactionCategory').value;
            const description = document.getElementById('transactionDescription').value;

            const transaction = {
                id: Date.now(),
                date,
                amount,
                category,
                description
            };

            state.months[monthId][type].push(transaction);
            saveState();
            db.ref(`months/${monthId}/${type}`).set(state.months[monthId][type]);
            renderMonth(monthId, state.months[monthId]);
            renderDashboard();
            elements.transactionModal.classList.add('hidden');
        }

        // Delete transaction
        function deleteTransaction(monthId, type, id) {
            state.months[monthId][type] = state.months[monthId][type].filter(t => t.id !== id);
            saveState();
            renderMonth(monthId, state.months[monthId]);
            renderDashboard();
            db.ref(`months/${monthId}/${type}`).set(state.months[monthId][type]);
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('financeMonths', JSON.stringify(state.months));
        }

        // Render dashboard with totals and chart
        function renderDashboard() {
            // Calculate totals
            const totals = {
                savings: 0,
                funSavings: 0,
                expenses: 0,
                funBudget: 0
            };

            for (const month in state.months) {
                const data = state.months[month];
                
                // Income (positive)
                const incomeTotal = data.income.reduce((sum, t) => sum + t.amount, 0);
                
                // Expenses (negative)
                const expensesTotal = data.expenses.reduce((sum, t) => sum + t.amount, 0);
                
                // Savings categories
                const savingsData = data.saving.reduce((acc, t) => {
                    if (t.category === 'Épargne') acc.savings += t.amount;
                    if (t.category === 'Épargne plaisir') acc.funSavings += t.amount;
                    if (t.category === 'Loisirs') acc.funBudget += t.amount;
                    return acc;
                }, { savings: 0, funSavings: 0, funBudget: 0 });

                totals.savings += savingsData.savings;
                totals.funSavings += savingsData.funSavings;
                totals.expenses += expensesTotal;
                totals.funBudget += savingsData.funBudget;
            }

            // Update DOM
            elements.totalSavings.textContent = `${totals.savings.toFixed(2)} €`;
            elements.totalFunSavings.textContent = `${totals.funSavings.toFixed(2)} €`;
            elements.totalExpenses.textContent = `${totals.expenses.toFixed(2)} €`;
            elements.totalFunBudget.textContent = `${totals.funBudget.toFixed(2)} €`;

            // Update pie chart
            updatePieChart(totals);
        }

        // Update pie chart
        function updatePieChart(totals) {
            const ctx = elements.financePieChart.getContext('2d');
            
            // If chart already exists, destroy it
            if (window.financeChart) {
                window.financeChart.destroy();
            }

            window.financeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Épargne', 'Épargne plaisir', 'Dépenses nécessaires', 'Budget plaisir'],
                    datasets: [{
                        data: [
                            totals.savings,
                            totals.funSavings,
                            totals.expenses,
                            totals.funBudget
                        ],
                        backgroundColor: [
                            'rgba(74, 222, 128, 0.7)',
                            'rgba(167, 139, 250, 0.7)',
                            'rgba(248, 113, 113, 0.7)',
                            'rgba(244, 114, 182, 0.7)'
                        ],
                        borderColor: [
                            'rgba(74, 222, 128, 1)',
                            'rgba(167, 139, 250, 1)',
                            'rgba(248, 113, 113, 1)',
                            'rgba(244, 114, 182, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(2)} €`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render all months
        function renderAllMonths() {
            elements.monthSections.innerHTML = '';
            for (const month in state.months) {
                renderMonth(month, state.months[month]);
            }
        }

        // Render a single month
        function renderMonth(monthId, monthData) {
            // Check if month already rendered
            let monthSection = document.getElementById(`month-${monthId}`);
            if (!monthSection) {
                monthSection = document.createElement('div');
                monthSection.id = `month-${monthId}`;
                monthSection.className = 'crisp-white rounded-lg shadow p-6';
                elements.monthSections.appendChild(monthSection);
            }

            // Month header
            monthSection.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">${monthId}</h2>
                    <div>
                        <button onclick="deleteMonth('${monthId}')" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">
                            Supprimer
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Income Table -->
                    <div class="light-blue rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-medium text-gray-700">Entrées d'argent</h3>
                            <button onclick="showTransactionForm('${monthId}', 'income')" class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                                Ajouter
                            </button>
                        </div>
                        <div class="overflow-auto" style="max-height: 300px;">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-2">Date</th>
                                        <th class="text-left py-2">Montant</th>
                                        <th class="text-left py-2">Catégorie</th>
                                        <th class="text-left py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="income-${monthId}">
                                    <!-- Income rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 font-medium text-gray-700">
                            Total: <span id="income-total-${monthId}" class="text-green-500">0 €</span>
                        </div>
                    </div>
                    
                    <!-- Expenses Table -->
                    <div class="powder-pink rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-medium text-gray-700">Dépenses nécessaires</h3>
                            <button onclick="showTransactionForm('${monthId}', 'expenses')" class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                                Ajouter
                            </button>
                        </div>
                        <div class="overflow-auto" style="max-height: 300px;">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-2">Date</th>
                                        <th class="text-left py-2">Montant</th>
                                        <th class="text-left py-2">Catégorie</th>
                                        <th class="text-left py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-${monthId}">
                                    <!-- Expenses rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 font-medium text-gray-700">
                            Total: <span id="expenses-total-${monthId}" class="text-red-500">0 €</span>
                        </div>
                    </div>
                    
                    <!-- Savings/Enjoyment Table -->
                    <div class="soft-yellow rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-medium text-gray-700">Plaisirs et Épargne</h3>
                            <button onclick="showTransactionForm('${monthId}', 'saving')" class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                                Ajouter
                            </button>
                        </div>
                        <div class="overflow-auto" style="max-height: 300px;">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-2">Date</th>
                                        <th class="text-left py-2">Montant</th>
                                        <th class="text-left py-2">Type</th>
                                        <th class="text-left py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="saving-${monthId}">
                                    <!-- Savings rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 font-medium text-gray-700">
                            Total: <span id="saving-total-${monthId}" class="text-yellow-600">0 €</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-700">Solde disponible:</span>
                        <span id="available-balance-${monthId}" class="text-xl font-semibold">0 €</span>
                    </div>
                </div>
            `;

            // Render income transactions
            renderTransactions(monthId, 'income');
            renderTransactions(monthId, 'expenses');
            renderTransactions(monthId, 'saving');
            calculateMonthBalance(monthId);
        }

        // Render transactions for a specific month and type
        function renderTransactions(monthId, type) {
            const container = document.getElementById(`${type}-${monthId}`);
            if (!container) return;

            container.innerHTML = '';
            const transactions = state.months[monthId][type] || [];
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-2 text-center text-gray-500">Aucune donnée</td>
                    </tr>
                `;
                document.getElementById(`${type}-total-${monthId}`).textContent = '0 €';
                return;
            }

            let total = 0;
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                
                const amountClass = type === 'income' ? 'text-green-500' : 'text-red-500';
                
                row.innerHTML = `
                    <td class="py-2">${formatDate(transaction.date)}</td>
                    <td class="py-2 ${amountClass}">${transaction.amount.toFixed(2)} €</td>
                    <td class="py-2">${transaction.category}</td>
                    <td class="py-2">
                        <button onclick="deleteTransaction('${monthId}', '${type}', ${transaction.id})" class="text-red-500 hover:text-red-700">
                            Supprimer
                        </button>
                    </td>
                `;
                
                container.appendChild(row);
                total += transaction.amount;
            });

            // Update total
            document.getElementById(`${type}-total-${monthId}`).textContent = `${total.toFixed(2)} €`;
        }

        // Calculate month balance (income - expenses - savings)
        function calculateMonthBalance(monthId) {
            const month = state.months[monthId];
            if (!month) return;

            const incomeTotal = month.income.reduce((sum, t) => sum + t.amount, 0);
            const expensesTotal = month.expenses.reduce((sum, t) => sum + t.amount, 0);
            const savingTotal = month.saving.reduce((sum, t) => sum + t.amount, 0);
            
            const balance = month.startingBalance + incomeTotal - expensesTotal - savingTotal;
            
            const balanceElement = document.getElementById(`available-balance-${monthId}`);
            balanceElement.textContent = `${balance.toFixed(2)} €`;
            
            // Color based on balance
            balanceElement.className = balance >= 0 ? 
                'text-xl font-semibold text-green-500' : 
                'text-xl font-semibold text-red-500';
        }

        // Delete a whole month
        function deleteMonth(monthId) {
            if (confirm(`Voulez-vous vraiment supprimer le mois ${monthId} ?`)) {
                delete state.months[monthId];
                db.ref('months/' + monthId).remove();
                saveState();
                document.getElementById(`month-${monthId}`).remove();
                renderDashboard();
            }
        }

        // Helper functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR');
        }

        // Expose functions to global scope for HTML event handlers
        window.showTransactionForm = showTransactionForm;
        window.deleteTransaction = deleteTransaction;
        window.deleteMonth = deleteMonth;
    </script>
</body>
</html>

